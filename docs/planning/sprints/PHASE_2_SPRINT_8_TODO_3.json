{
  "phase": 2,
  "sprint": 8,
  "todoFile": 3,
  "title": "Headers, Footers & Page Numbers",
  "priority": "HIGH",
  "effort": "4 hours",
  "status": "pending",
  "milestone": "v2.0 Release",
  "tasks": [
    {
      "id": "2.8.7",
      "category": "implementation",
      "title": "Implement Header/Footer Function",
      "description": "Create the function to add headers and footers with variable substitution.",
      "status": "pending",
      "estimatedHours": 2,
      "agent": "sonnet",
      "files": ["src/lib/batch/headerFooter.ts"],
      "testCategories": ["unit", "integration"],
      "stepByStep": [
        {
          "step": 1,
          "action": "Implement applyHeaderFooter function",
          "code": "import { PDFDocument, rgb, StandardFonts, PDFFont, PDFPage } from 'pdf-lib';\nimport type { HeaderFooterOptions, PageRange } from './types';\n\nexport interface HeaderFooterSection {\n  left?: string;\n  center?: string;\n  right?: string;\n}\n\nexport interface HeaderFooterOptions {\n  header?: HeaderFooterSection;\n  footer?: HeaderFooterSection;\n  font: {\n    family: string;\n    size: number;\n    color: string;\n    bold?: boolean;\n    italic?: boolean;\n  };\n  margins: {\n    top: number;\n    bottom: number;\n    left: number;\n    right: number;\n  };\n  startPage: number;\n  pages: PageRange;\n  pageNumberFormat: 'arabic' | 'roman' | 'romanUpper' | 'letter' | 'letterUpper';\n}\n\nexport async function applyHeaderFooter(\n  pdfBytes: ArrayBuffer,\n  options: HeaderFooterOptions\n): Promise<ArrayBuffer> {\n  try {\n    const pdfDoc = await PDFDocument.load(pdfBytes);\n    const font = await pdfDoc.embedFont(StandardFonts.Helvetica);\n    const pages = pdfDoc.getPages();\n    const totalPages = pages.length;\n\n    const pageIndices = getPageIndices(pages.length, options.pages);\n\n    // Get document metadata for variables\n    const metadata = {\n      filename: 'Document', // Would come from store\n      author: '', // Would come from PDF metadata\n      date: formatDate(new Date()),\n      time: formatTime(new Date()),\n    };\n\n    for (const pageIndex of pageIndices) {\n      const page = pages[pageIndex];\n      const pageNumber = pageIndex + 1;\n      const { width, height } = page.getSize();\n\n      const variables: Record<string, string> = {\n        page: formatPageNumber(pageNumber, options.pageNumberFormat),\n        total: formatPageNumber(totalPages, options.pageNumberFormat),\n        date: metadata.date,\n        time: metadata.time,\n        filename: metadata.filename,\n        author: metadata.author,\n      };\n\n      // Draw header\n      if (options.header) {\n        const y = height - options.margins.top;\n        drawSection(page, font, options.header, variables, {\n          y,\n          fontSize: options.font.size,\n          color: hexToRgbValues(options.font.color),\n          marginLeft: options.margins.left,\n          marginRight: options.margins.right,\n          pageWidth: width,\n        });\n      }\n\n      // Draw footer\n      if (options.footer) {\n        const y = options.margins.bottom;\n        drawSection(page, font, options.footer, variables, {\n          y,\n          fontSize: options.font.size,\n          color: hexToRgbValues(options.font.color),\n          marginLeft: options.margins.left,\n          marginRight: options.margins.right,\n          pageWidth: width,\n        });\n      }\n    }\n\n    return pdfDoc.save();\n  } catch (error) {\n    throw new Error(`Header/footer failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n}\n\nfunction drawSection(\n  page: PDFPage,\n  font: PDFFont,\n  section: HeaderFooterSection,\n  variables: Record<string, string>,\n  options: {\n    y: number;\n    fontSize: number;\n    color: { r: number; g: number; b: number };\n    marginLeft: number;\n    marginRight: number;\n    pageWidth: number;\n  }\n): void {\n  const { y, fontSize, color, marginLeft, marginRight, pageWidth } = options;\n\n  // Left text\n  if (section.left) {\n    const text = substituteVariables(section.left, variables);\n    page.drawText(text, {\n      x: marginLeft,\n      y,\n      size: fontSize,\n      font,\n      color: rgb(color.r, color.g, color.b),\n    });\n  }\n\n  // Center text\n  if (section.center) {\n    const text = substituteVariables(section.center, variables);\n    const textWidth = font.widthOfTextAtSize(text, fontSize);\n    const x = (pageWidth - textWidth) / 2;\n    page.drawText(text, {\n      x,\n      y,\n      size: fontSize,\n      font,\n      color: rgb(color.r, color.g, color.b),\n    });\n  }\n\n  // Right text\n  if (section.right) {\n    const text = substituteVariables(section.right, variables);\n    const textWidth = font.widthOfTextAtSize(text, fontSize);\n    const x = pageWidth - marginRight - textWidth;\n    page.drawText(text, {\n      x,\n      y,\n      size: fontSize,\n      font,\n      color: rgb(color.r, color.g, color.b),\n    });\n  }\n}\n\nfunction substituteVariables(template: string, variables: Record<string, string>): string {\n  return template.replace(/\\{\\{(\\w+)\\}\\}/g, (match, key) => {\n    return variables[key] ?? match;\n  });\n}\n\nfunction formatPageNumber(num: number, format: string): string {\n  switch (format) {\n    case 'roman':\n      return toRoman(num).toLowerCase();\n    case 'romanUpper':\n      return toRoman(num);\n    case 'letter':\n      return toLetter(num).toLowerCase();\n    case 'letterUpper':\n      return toLetter(num);\n    case 'arabic':\n    default:\n      return num.toString();\n  }\n}\n\nfunction toRoman(num: number): string {\n  const romanNumerals: [number, string][] = [\n    [1000, 'M'], [900, 'CM'], [500, 'D'], [400, 'CD'],\n    [100, 'C'], [90, 'XC'], [50, 'L'], [40, 'XL'],\n    [10, 'X'], [9, 'IX'], [5, 'V'], [4, 'IV'], [1, 'I']\n  ];\n  \n  let result = '';\n  for (const [value, symbol] of romanNumerals) {\n    while (num >= value) {\n      result += symbol;\n      num -= value;\n    }\n  }\n  return result;\n}\n\nfunction toLetter(num: number): string {\n  let result = '';\n  while (num > 0) {\n    num--;\n    result = String.fromCharCode(65 + (num % 26)) + result;\n    num = Math.floor(num / 26);\n  }\n  return result;\n}\n\nfunction formatDate(date: Date): string {\n  return date.toLocaleDateString();\n}\n\nfunction formatTime(date: Date): string {\n  return date.toLocaleTimeString();\n}\n\nfunction hexToRgbValues(hex: string): { r: number; g: number; b: number } {\n  const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\n  return result ? {\n    r: parseInt(result[1], 16) / 255,\n    g: parseInt(result[2], 16) / 255,\n    b: parseInt(result[3], 16) / 255,\n  } : { r: 0, g: 0, b: 0 };\n}\n\nfunction getPageIndices(totalPages: number, range: PageRange): number[] {\n  switch (range.type) {\n    case 'all': return Array.from({ length: totalPages }, (_, i) => i);\n    case 'even': return Array.from({ length: totalPages }, (_, i) => i).filter(i => (i + 1) % 2 === 0);\n    case 'odd': return Array.from({ length: totalPages }, (_, i) => i).filter(i => (i + 1) % 2 === 1);\n    case 'custom': return (range.customPages ?? []).filter(p => p >= 0 && p < totalPages);\n    default: return Array.from({ length: totalPages }, (_, i) => i);\n  }\n}"
        }
      ],
      "acceptanceCriteria": [
        "Headers render at top of page",
        "Footers render at bottom of page",
        "Left/center/right alignment works",
        "{{page}} and {{total}} variables substitute",
        "{{date}} and {{time}} variables work",
        "Page number formats (arabic, roman, letter) work",
        "Font styling applies"
      ]
    },
    {
      "id": "2.8.8",
      "category": "ui",
      "title": "Create Header/Footer Dialog Component",
      "description": "Build the UI for configuring headers and footers with preview.",
      "status": "pending",
      "estimatedHours": 2,
      "agent": "sonnet",
      "files": ["src/components/batch/HeaderFooterDialog.tsx"],
      "testCategories": ["visual", "integration"],
      "stepByStep": [
        {
          "step": 1,
          "action": "Create HeaderFooterDialog component with accessibility",
          "code": "import { useState } from 'react';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from '@components/ui/Dialog';\nimport { Button } from '@components/ui/Button';\nimport { Input } from '@components/ui/Input';\nimport { Select } from '@components/ui/Select';\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from '@radix-ui/react-tabs';\nimport { useBatchStore } from '@stores/batchStore';\nimport type { HeaderFooterOptions } from '@lib/batch/headerFooter';\n\nconst VARIABLES = [\n  { name: '{{page}}', description: 'Current page number' },\n  { name: '{{total}}', description: 'Total page count' },\n  { name: '{{date}}', description: 'Current date' },\n  { name: '{{time}}', description: 'Current time' },\n  { name: '{{filename}}', description: 'Document filename' },\n];\n\nconst PAGE_NUMBER_FORMATS = [\n  { value: 'arabic', label: '1, 2, 3...' },\n  { value: 'roman', label: 'i, ii, iii...' },\n  { value: 'romanUpper', label: 'I, II, III...' },\n  { value: 'letter', label: 'a, b, c...' },\n  { value: 'letterUpper', label: 'A, B, C...' },\n];\n\nexport function HeaderFooterDialog({ isOpen, onClose }: { isOpen: boolean; onClose: () => void }) {\n  const { addOperation } = useBatchStore();\n  const [activeTab, setActiveTab] = useState<'header' | 'footer'>('header');\n  const [options, setOptions] = useState<HeaderFooterOptions>({\n    header: { left: '', center: '', right: '' },\n    footer: { left: '', center: 'Page {{page}} of {{total}}', right: '' },\n    font: { family: 'Helvetica', size: 10, color: '#000000' },\n    margins: { top: 30, bottom: 30, left: 50, right: 50 },\n    startPage: 1,\n    pages: { type: 'all' },\n    pageNumberFormat: 'arabic',\n  });\n\n  const updateSection = (section: 'header' | 'footer', position: 'left' | 'center' | 'right', value: string) => {\n    setOptions(prev => ({\n      ...prev,\n      [section]: {\n        ...prev[section],\n        [position]: value,\n      },\n    }));\n  };\n\n  const insertVariable = (variable: string, section: 'header' | 'footer', position: 'left' | 'center' | 'right') => {\n    const current = options[section]?.[position] || '';\n    updateSection(section, position, current + variable);\n  };\n\n  const handleApply = () => {\n    addOperation('header-footer', options);\n    onClose();\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={(open) => !open && onClose()}>\n      <DialogContent className=\"max-w-2xl\" aria-describedby=\"hf-dialog-desc\">\n        <DialogHeader>\n          <DialogTitle>Add Headers & Footers</DialogTitle>\n        </DialogHeader>\n        <p id=\"hf-dialog-desc\" className=\"text-sm text-gray-600\">\n          Configure text to appear at the top and bottom of each page.\n        </p>\n\n        <Tabs value={activeTab} onValueChange={(v) => setActiveTab(v as 'header' | 'footer')}>\n          <TabsList className=\"mb-4\">\n            <TabsTrigger value=\"header\">Header</TabsTrigger>\n            <TabsTrigger value=\"footer\">Footer</TabsTrigger>\n          </TabsList>\n\n          {(['header', 'footer'] as const).map(section => (\n            <TabsContent key={section} value={section} className=\"space-y-4\">\n              <div className=\"grid grid-cols-3 gap-4\">\n                {(['left', 'center', 'right'] as const).map(position => (\n                  <div key={position}>\n                    <label className=\"text-sm font-medium capitalize\" htmlFor={`${section}-${position}`}>\n                      {position}\n                    </label>\n                    <Input\n                      id={`${section}-${position}`}\n                      value={options[section]?.[position] || ''}\n                      onChange={(e) => updateSection(section, position, e.target.value)}\n                      placeholder={`${position} text...`}\n                    />\n                  </div>\n                ))}\n              </div>\n\n              {/* Variable Buttons */}\n              <div>\n                <span className=\"text-sm font-medium\">Insert Variable:</span>\n                <div className=\"flex flex-wrap gap-2 mt-1\">\n                  {VARIABLES.map(v => (\n                    <button\n                      key={v.name}\n                      onClick={() => insertVariable(v.name, section, 'center')}\n                      className=\"px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 rounded\"\n                      title={v.description}\n                      type=\"button\"\n                    >\n                      {v.name}\n                    </button>\n                  ))}\n                </div>\n              </div>\n            </TabsContent>\n          ))}\n        </Tabs>\n\n        {/* Options */}\n        <div className=\"space-y-4 border-t pt-4\">\n          <div className=\"grid grid-cols-2 gap-4\">\n            <div>\n              <label className=\"text-sm font-medium\" htmlFor=\"font-size\">Font Size</label>\n              <Input\n                id=\"font-size\"\n                type=\"number\"\n                value={options.font.size}\n                onChange={(e) => setOptions(prev => ({\n                  ...prev,\n                  font: { ...prev.font, size: parseInt(e.target.value) || 10 },\n                }))}\n                min={6}\n                max={24}\n              />\n            </div>\n            <div>\n              <label className=\"text-sm font-medium\" htmlFor=\"page-format\">Page Number Format</label>\n              <Select\n                id=\"page-format\"\n                value={options.pageNumberFormat}\n                onChange={(e) => setOptions(prev => ({\n                  ...prev,\n                  pageNumberFormat: e.target.value as any,\n                }))}\n              >\n                {PAGE_NUMBER_FORMATS.map(f => (\n                  <option key={f.value} value={f.value}>{f.label}</option>\n                ))}\n              </Select>\n            </div>\n          </div>\n\n          <div>\n            <label className=\"text-sm font-medium\" htmlFor=\"font-color\">Font Color</label>\n            <input\n              id=\"font-color\"\n              type=\"color\"\n              value={options.font.color}\n              onChange={(e) => setOptions(prev => ({\n                ...prev,\n                font: { ...prev.font, color: e.target.value },\n              }))}\n              className=\"w-10 h-8 p-0 border rounded cursor-pointer\"\n            />\n          </div>\n        </div>\n\n        {/* Preview */}\n        <div className=\"border rounded-lg p-4 bg-gray-50 dark:bg-gray-800\">\n          <div className=\"text-sm font-medium mb-2\">Preview</div>\n          <div className=\"border bg-white dark:bg-gray-900 p-4\" style={{ minHeight: '120px' }}>\n            {/* Header Preview */}\n            <div className=\"flex justify-between text-xs border-b pb-2 mb-4\" style={{ color: options.font.color }}>\n              <span>{substitutePreview(options.header?.left)}</span>\n              <span>{substitutePreview(options.header?.center)}</span>\n              <span>{substitutePreview(options.header?.right)}</span>\n            </div>\n            \n            <div className=\"text-center text-gray-400 text-xs py-4\">[Page Content]</div>\n            \n            {/* Footer Preview */}\n            <div className=\"flex justify-between text-xs border-t pt-2 mt-4\" style={{ color: options.font.color }}>\n              <span>{substitutePreview(options.footer?.left)}</span>\n              <span>{substitutePreview(options.footer?.center)}</span>\n              <span>{substitutePreview(options.footer?.right)}</span>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"flex justify-end gap-2\">\n          <Button variant=\"ghost\" onClick={onClose}>Cancel</Button>\n          <Button onClick={handleApply}>Add to Queue</Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n\nfunction substitutePreview(text?: string): string {\n  if (!text) return '';\n  return text\n    .replace('{{page}}', '1')\n    .replace('{{total}}', '10')\n    .replace('{{date}}', new Date().toLocaleDateString())\n    .replace('{{time}}', new Date().toLocaleTimeString())\n    .replace('{{filename}}', 'Document.pdf');\n}"
        }
      ],
      "acceptanceCriteria": [
        "Dialog has header and footer tabs",
        "Left/center/right inputs work",
        "Variable buttons insert templates",
        "Font size and color configurable",
        "Page number format selection works",
        "Preview shows formatted output",
        "Dialog is keyboard accessible"
      ]
    }
  ],
  "successCriteria": [
    "Headers and footers apply correctly",
    "Variable substitution works",
    "UI is intuitive for configuration"
  ],
  "filesCreated": [
    "src/lib/batch/headerFooter.ts",
    "src/components/batch/HeaderFooterDialog.tsx",
    "tests/unit/lib/batch/headerFooter.test.ts",
    "tests/unit/components/batch/HeaderFooterDialog.test.tsx"
  ],
  "filesModified": [],
  "totalNewTests": 10,
  "totalEstimatedHours": 4,
  "dependencies": ["2.8.1", "2.8.2"],
  "notes": [
    "Font embedding may be needed for non-standard fonts",
    "Consider adding margin adjustment UI",
    "Preview should update in real-time"
  ]
}
