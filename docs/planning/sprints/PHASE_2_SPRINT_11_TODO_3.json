{
  "phase": 2,
  "sprint": 11,
  "todoFile": 3,
  "title": "Color Contrast & Reading Order Rules + UI",
  "priority": "HIGH",
  "effort": "4 hours",
  "status": "pending",
  "milestone": "v2.5 Release",
  "tasks": [
    {
      "id": "2.11.7",
      "category": "implementation",
      "title": "Implement Color Contrast Rules",
      "description": "Create rules for checking text color contrast ratios against WCAG guidelines.",
      "status": "pending",
      "estimatedHours": 2,
      "agent": "sonnet",
      "files": ["src/lib/accessibility/rules/colorContrast.ts"],
      "testCategories": ["unit"],
      "stepByStep": [
        {
          "step": 1,
          "action": "Create color contrast rules with WCAG calculations",
          "code": "import type { AccessibilityRule, AccessibilityIssue, CheckContext } from '../types';\nimport { v4 as uuidv4 } from 'uuid';\n\n// WCAG 2.1 contrast thresholds\nconst CONTRAST_THRESHOLDS = {\n  AA_NORMAL: 4.5,\n  AA_LARGE: 3.0,\n  AAA_NORMAL: 7.0,\n  AAA_LARGE: 4.5,\n};\n\nconst LARGE_TEXT_SIZE = 18; // 18pt or 14pt bold\n\nexport const COLOR_CONTRAST_RULES: AccessibilityRule[] = [\n  {\n    id: 'contrast-minimum',\n    name: 'Minimum Contrast',\n    description: 'Text must have sufficient contrast with its background (4.5:1 for normal text, 3:1 for large text)',\n    category: 'color-contrast',\n    severity: 'error',\n    wcagCriteria: '1.4.3',\n    wcagLevel: 'AA',\n    check: async (context: CheckContext): Promise<AccessibilityIssue[]> => {\n      const issues: AccessibilityIssue[] = [];\n\n      // Note: Full contrast checking requires rendering pages and analyzing colors\n      // This is a simplified implementation that checks if contrast info is available\n      \n      if (!context.pdfDocument) {\n        return issues;\n      }\n\n      const numPages = context.pdfDocument.numPages;\n\n      for (let i = 1; i <= Math.min(numPages, 5); i++) { // Check first 5 pages for performance\n        try {\n          const page = await context.pdfDocument.getPage(i);\n          const textContent = await page.getTextContent();\n\n          for (const item of textContent.items as any[]) {\n            // PDF.js doesn't always provide color info\n            // In a full implementation, you'd render and analyze colors\n            \n            // Placeholder: Check if item has color metadata\n            if (item.transform && item.str && item.str.trim()) {\n              // Approximate font size from transform matrix\n              const fontSize = Math.abs(item.transform[0]) || 12;\n              const isLargeText = fontSize >= LARGE_TEXT_SIZE;\n\n              // Note: Real implementation would get actual colors\n              // This is a framework for the check\n            }\n          }\n        } catch (error) {\n          console.warn(`Could not check contrast on page ${i}:`, error);\n        }\n      }\n\n      // Add informational issue if we can't fully check\n      if (numPages > 0) {\n        issues.push({\n          id: uuidv4(),\n          ruleId: 'contrast-minimum',\n          ruleName: 'Minimum Contrast',\n          category: 'color-contrast',\n          severity: 'info',\n          description: 'Color contrast checking is limited in PDF documents. Manual verification recommended.',\n          recommendation: 'Review text and background color combinations manually to ensure sufficient contrast (4.5:1 for normal text, 3:1 for large text).',\n          wcagCriteria: '1.4.3',\n          wcagLevel: 'AA',\n          canAutoFix: false,\n        });\n      }\n\n      return issues;\n    },\n  },\n\n  {\n    id: 'color-only-info',\n    name: 'Use of Color',\n    description: 'Information should not be conveyed by color alone',\n    category: 'color-contrast',\n    severity: 'warning',\n    wcagCriteria: '1.4.1',\n    wcagLevel: 'A',\n    check: (context: CheckContext): AccessibilityIssue[] => {\n      // This check is informational - detecting color-only information\n      // requires semantic understanding of content\n      return [{\n        id: uuidv4(),\n        ruleId: 'color-only-info',\n        ruleName: 'Use of Color',\n        category: 'color-contrast',\n        severity: 'info',\n        description: 'Manual check recommended: Ensure information is not conveyed by color alone.',\n        recommendation: 'Review any use of color (e.g., red for errors, green for success) and ensure there are additional indicators like icons, text labels, or patterns.',\n        wcagCriteria: '1.4.1',\n        wcagLevel: 'A',\n        canAutoFix: false,\n      }];\n    },\n  },\n];\n\n// Utility functions for contrast calculation\nexport function calculateContrastRatio(color1: RGB, color2: RGB): number {\n  const lum1 = getRelativeLuminance(color1);\n  const lum2 = getRelativeLuminance(color2);\n  const lighter = Math.max(lum1, lum2);\n  const darker = Math.min(lum1, lum2);\n  return (lighter + 0.05) / (darker + 0.05);\n}\n\nfunction getRelativeLuminance(color: RGB): number {\n  const [r, g, b] = [color.r, color.g, color.b].map(val => {\n    val = val / 255;\n    return val <= 0.03928 ? val / 12.92 : Math.pow((val + 0.055) / 1.055, 2.4);\n  });\n  return 0.2126 * r + 0.7152 * g + 0.0722 * b;\n}\n\nexport function meetsContrastRequirement(\n  foreground: RGB,\n  background: RGB,\n  level: 'AA' | 'AAA',\n  isLargeText: boolean\n): boolean {\n  const ratio = calculateContrastRatio(foreground, background);\n  const threshold = level === 'AAA'\n    ? (isLargeText ? CONTRAST_THRESHOLDS.AAA_LARGE : CONTRAST_THRESHOLDS.AAA_NORMAL)\n    : (isLargeText ? CONTRAST_THRESHOLDS.AA_LARGE : CONTRAST_THRESHOLDS.AA_NORMAL);\n  return ratio >= threshold;\n}\n\ninterface RGB {\n  r: number;\n  g: number;\n  b: number;\n}"
        }
      ],
      "acceptanceCriteria": [
        "Contrast calculation is accurate per WCAG formula",
        "Large text threshold is correctly applied",
        "Both AA and AAA levels can be checked",
        "Informational message when full check not possible",
        "Color-only information warning included"
      ]
    },
    {
      "id": "2.11.8",
      "category": "ui",
      "title": "Create Accessibility Panel Component",
      "description": "Build the UI panel for displaying accessibility check results and issue navigation.",
      "status": "pending",
      "estimatedHours": 2,
      "agent": "sonnet",
      "files": ["src/components/accessibility/AccessibilityPanel.tsx", "src/components/accessibility/IssueList.tsx"],
      "testCategories": ["visual", "integration"],
      "stepByStep": [
        {
          "step": 1,
          "action": "Create AccessibilityPanel component with full accessibility",
          "code": "import { useState } from 'react';\nimport { FileCheck, AlertCircle, AlertTriangle, Info, ChevronDown, Download, RefreshCw } from 'lucide-react';\nimport { Button } from '@components/ui/Button';\nimport { Progress } from '@components/ui/Progress';\nimport { Select } from '@components/ui/Select';\nimport { useAccessibilityStore } from '@stores/accessibilityStore';\nimport { IssueList } from './IssueList';\nimport { cn } from '@utils/cn';\nimport type { IssueCategory, IssueSeverity } from '@lib/accessibility/types';\n\nexport function AccessibilityPanel() {\n  const {\n    isChecking,\n    progress,\n    currentCheck,\n    report,\n    filterCategory,\n    filterSeverity,\n    setFilterCategory,\n    setFilterSeverity,\n    runCheck,\n    exportReport,\n  } = useAccessibilityStore();\n\n  const [isExporting, setIsExporting] = useState(false);\n\n  const handleExport = async (format: 'pdf' | 'html' | 'json') => {\n    setIsExporting(true);\n    try {\n      const blob = await exportReport(format);\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `accessibility-report.${format}`;\n      a.click();\n      URL.revokeObjectURL(url);\n    } catch (error) {\n      console.error('Export failed:', error);\n    } finally {\n      setIsExporting(false);\n    }\n  };\n\n  return (\n    <div className=\"flex flex-col h-full\">\n      {/* Header */}\n      <div className=\"p-4 border-b\">\n        <div className=\"flex items-center justify-between mb-2\">\n          <h2 className=\"font-semibold flex items-center gap-2\">\n            <FileCheck className=\"h-5 w-5\" aria-hidden=\"true\" />\n            Accessibility Checker\n          </h2>\n          <Button\n            onClick={runCheck}\n            disabled={isChecking}\n            size=\"sm\"\n            aria-busy={isChecking}\n          >\n            {isChecking ? (\n              <><RefreshCw className=\"h-4 w-4 mr-1 animate-spin\" aria-hidden=\"true\" />Checking...</>\n            ) : (\n              'Run Check'\n            )}\n          </Button>\n        </div>\n\n        {/* Progress */}\n        {isChecking && (\n          <div className=\"space-y-1\" role=\"progressbar\" aria-valuenow={progress} aria-valuemin={0} aria-valuemax={100}>\n            <Progress value={progress} className=\"h-2\" />\n            <p className=\"text-xs text-gray-500\">{currentCheck}</p>\n          </div>\n        )}\n      </div>\n\n      {/* Results */}\n      {report && (\n        <>\n          {/* Score Summary */}\n          <div\n            className={cn(\n              'p-4 border-b',\n              report.pdfUACompliant ? 'bg-green-50 dark:bg-green-900/20' : 'bg-red-50 dark:bg-red-900/20'\n            )}\n            role=\"status\"\n            aria-live=\"polite\"\n          >\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <div className=\"text-2xl font-bold\">{report.score}%</div>\n                <div className=\"text-sm text-gray-600\">\n                  {report.pdfUACompliant ? 'PDF/UA Compliant' : 'Not Compliant'}\n                </div>\n              </div>\n              <div className=\"text-right\">\n                <div className=\"flex items-center gap-4 text-sm\">\n                  <span className=\"flex items-center gap-1 text-red-600\">\n                    <AlertCircle className=\"h-4 w-4\" aria-hidden=\"true\" />\n                    {report.summary.errors} errors\n                  </span>\n                  <span className=\"flex items-center gap-1 text-yellow-600\">\n                    <AlertTriangle className=\"h-4 w-4\" aria-hidden=\"true\" />\n                    {report.summary.warnings} warnings\n                  </span>\n                </div>\n                <div className=\"text-xs text-gray-500 mt-1\">\n                  WCAG Level: {report.wcagLevel || 'None'}\n                </div>\n              </div>\n            </div>\n          </div>\n\n          {/* Filters */}\n          <div className=\"p-2 border-b flex items-center gap-2\">\n            <label htmlFor=\"filter-category\" className=\"text-sm sr-only\">Filter by category</label>\n            <Select\n              id=\"filter-category\"\n              value={filterCategory}\n              onChange={(e) => setFilterCategory(e.target.value as IssueCategory | 'all')}\n              className=\"text-sm h-8\"\n            >\n              <option value=\"all\">All Categories</option>\n              <option value=\"document-structure\">Document Structure</option>\n              <option value=\"text-alternatives\">Text Alternatives</option>\n              <option value=\"tables\">Tables</option>\n              <option value=\"reading-order\">Reading Order</option>\n              <option value=\"color-contrast\">Color Contrast</option>\n              <option value=\"metadata\">Metadata</option>\n            </Select>\n\n            <label htmlFor=\"filter-severity\" className=\"text-sm sr-only\">Filter by severity</label>\n            <Select\n              id=\"filter-severity\"\n              value={filterSeverity}\n              onChange={(e) => setFilterSeverity(e.target.value as IssueSeverity | 'all')}\n              className=\"text-sm h-8\"\n            >\n              <option value=\"all\">All Severities</option>\n              <option value=\"error\">Errors</option>\n              <option value=\"warning\">Warnings</option>\n              <option value=\"info\">Info</option>\n            </Select>\n          </div>\n\n          {/* Issue List */}\n          <IssueList />\n\n          {/* Export */}\n          <div className=\"p-2 border-t\">\n            <div className=\"flex items-center gap-2\">\n              <span className=\"text-sm text-gray-600\">Export:</span>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => handleExport('html')}\n                disabled={isExporting}\n              >\n                HTML\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={() => handleExport('json')}\n                disabled={isExporting}\n              >\n                JSON\n              </Button>\n            </div>\n          </div>\n        </>\n      )}\n\n      {/* Empty State */}\n      {!isChecking && !report && (\n        <div className=\"flex-1 flex items-center justify-center text-center p-8\">\n          <div>\n            <FileCheck className=\"h-12 w-12 mx-auto text-gray-400 mb-4\" aria-hidden=\"true\" />\n            <p className=\"text-gray-600 mb-4\">Check your document for accessibility issues</p>\n            <Button onClick={runCheck}>Run Accessibility Check</Button>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}"
        },
        {
          "step": 2,
          "action": "Create IssueList component",
          "code": "import { AlertCircle, AlertTriangle, Info, ChevronRight, Wrench } from 'lucide-react';\nimport { Button } from '@components/ui/Button';\nimport { useAccessibilityStore } from '@stores/accessibilityStore';\nimport { useDocumentStore } from '@stores/documentStore';\nimport { cn } from '@utils/cn';\nimport type { AccessibilityIssue } from '@lib/accessibility/types';\n\nexport function IssueList() {\n  const { getFilteredIssues, selectedIssueId, selectIssue, applyAutoFix } = useAccessibilityStore();\n  const { goToPage } = useDocumentStore();\n\n  const issues = getFilteredIssues();\n\n  const handleIssueClick = (issue: AccessibilityIssue) => {\n    selectIssue(issue.id);\n    if (issue.pageIndex !== undefined) {\n      goToPage(issue.pageIndex);\n    }\n  };\n\n  const handleAutoFix = async (e: React.MouseEvent, issueId: string) => {\n    e.stopPropagation();\n    await applyAutoFix(issueId);\n  };\n\n  if (issues.length === 0) {\n    return (\n      <div className=\"flex-1 flex items-center justify-center p-8 text-gray-500\">\n        No issues match the current filters.\n      </div>\n    );\n  }\n\n  return (\n    <ul className=\"flex-1 overflow-y-auto\" role=\"list\" aria-label=\"Accessibility issues\">\n      {issues.map((issue) => (\n        <li key={issue.id}>\n          <button\n            onClick={() => handleIssueClick(issue)}\n            className={cn(\n              'w-full text-left p-3 border-b hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors',\n              selectedIssueId === issue.id && 'bg-blue-50 dark:bg-blue-900/20'\n            )}\n            aria-expanded={selectedIssueId === issue.id}\n            aria-label={`${issue.severity}: ${issue.ruleName}. ${issue.description}`}\n          >\n            <div className=\"flex items-start gap-2\">\n              <IssueIcon severity={issue.severity} />\n              <div className=\"flex-1 min-w-0\">\n                <div className=\"font-medium text-sm truncate\">{issue.ruleName}</div>\n                <div className=\"text-xs text-gray-600 line-clamp-2\">{issue.description}</div>\n                {issue.wcagCriteria && (\n                  <div className=\"text-xs text-gray-400 mt-1\">\n                    WCAG {issue.wcagCriteria} (Level {issue.wcagLevel})\n                  </div>\n                )}\n              </div>\n              <div className=\"flex items-center gap-1\">\n                {issue.canAutoFix && (\n                  <Button\n                    variant=\"ghost\"\n                    size=\"icon\"\n                    className=\"h-6 w-6\"\n                    onClick={(e) => handleAutoFix(e, issue.id)}\n                    aria-label=\"Auto-fix this issue\"\n                  >\n                    <Wrench className=\"h-3 w-3\" />\n                  </Button>\n                )}\n                {issue.pageIndex !== undefined && (\n                  <span className=\"text-xs text-gray-400\">\n                    p.{issue.pageIndex + 1}\n                  </span>\n                )}\n                <ChevronRight className=\"h-4 w-4 text-gray-400\" aria-hidden=\"true\" />\n              </div>\n            </div>\n\n            {/* Expanded Details */}\n            {selectedIssueId === issue.id && (\n              <div className=\"mt-3 pt-3 border-t space-y-2\">\n                <div>\n                  <div className=\"text-xs font-medium text-gray-500\">Recommendation</div>\n                  <div className=\"text-sm\">{issue.recommendation}</div>\n                </div>\n                {issue.element && (\n                  <div>\n                    <div className=\"text-xs font-medium text-gray-500\">Element</div>\n                    <div className=\"text-sm font-mono bg-gray-100 dark:bg-gray-800 px-2 py-1 rounded\">\n                      {issue.element}\n                    </div>\n                  </div>\n                )}\n                {issue.helpUrl && (\n                  <a\n                    href={issue.helpUrl}\n                    target=\"_blank\"\n                    rel=\"noopener noreferrer\"\n                    className=\"text-sm text-primary-500 hover:underline\"\n                  >\n                    Learn more about this issue\n                  </a>\n                )}\n              </div>\n            )}\n          </button>\n        </li>\n      ))}\n    </ul>\n  );\n}\n\nfunction IssueIcon({ severity }: { severity: 'error' | 'warning' | 'info' }) {\n  switch (severity) {\n    case 'error':\n      return <AlertCircle className=\"h-4 w-4 text-red-500 flex-shrink-0\" aria-hidden=\"true\" />;\n    case 'warning':\n      return <AlertTriangle className=\"h-4 w-4 text-yellow-500 flex-shrink-0\" aria-hidden=\"true\" />;\n    case 'info':\n      return <Info className=\"h-4 w-4 text-blue-500 flex-shrink-0\" aria-hidden=\"true\" />;\n  }\n}"
        }
      ],
      "acceptanceCriteria": [
        "Panel displays score and compliance status",
        "Error and warning counts are accurate",
        "Category and severity filters work",
        "Clicking an issue navigates to page",
        "Expanded view shows recommendation",
        "Auto-fix button works for supported issues",
        "Export generates correct formats",
        "Fully keyboard accessible",
        "Screen reader announcements work"
      ]
    }
  ],
  "successCriteria": [
    "Color contrast rules provide guidance",
    "Accessibility panel is intuitive",
    "Issue navigation works correctly"
  ],
  "filesCreated": [
    "src/lib/accessibility/rules/colorContrast.ts",
    "src/components/accessibility/AccessibilityPanel.tsx",
    "src/components/accessibility/IssueList.tsx",
    "tests/unit/lib/accessibility/rules/colorContrast.test.ts",
    "tests/unit/components/accessibility/AccessibilityPanel.test.tsx"
  ],
  "filesModified": [],
  "totalNewTests": 10,
  "totalEstimatedHours": 4,
  "dependencies": ["2.11.1", "2.11.2", "2.11.3", "2.11.4", "2.11.5", "2.11.6"],
  "notes": [
    "Full color contrast checking requires rendering - simplified implementation",
    "Consider adding contrast preview/simulation",
    "Help URLs should point to WCAG documentation"
  ]
}
